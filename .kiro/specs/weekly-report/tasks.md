# 구현 계획: 주간 리포트 시스템

## 개요

이 구현 계획은 주간 리포트 시스템을 개별 코딩 작업으로 세분화합니다. 시스템은 Python과 FastAPI를 사용하여 구축되며, AWS 서비스(Bedrock, SES, Cognito)와 통합되고 Kubernetes 마이크로서비스로 배포됩니다. 작업은 점진적으로 구축되도록 구성되어 있으며, 테스트가 전체적으로 통합되어 있습니다.

## 작업 목록

- [x] 1. 프로젝트 구조 및 핵심 의존성 설정
  - FastAPI, boto3, SQLAlchemy, pytest, hypothesis를 사용한 Python 프로젝트 생성
  - 디렉토리 구조 설정: `/app`, `/tests`, `/config`, `/models`, `/services`, `/api`
  - AWS 자격 증명 및 서비스 ID를 위한 환경 변수 구성
  - AWS Secrets Manager 클라이언트 구성하여 `library-api/db-password` 시크릿 가져오기
  - `requirements.txt` 및 `Dockerfile` 생성
  - _요구사항: 8.1_

- [x] 2. 데이터 모델 및 데이터베이스 레이어 구현
  - [x] 2.1 기존 테이블용 SQLAlchemy 모델 생성 (읽기 전용)
    - 기존 `history` 테이블 매핑: id, user_id, content, record_date, tags, s3_key, text_url
    - 기존 `users` 테이블 매핑: user_id, email, nickname, status, created_at, updated_at, deleted_at
    - 읽기 전용으로 사용 (기존 데이터 변경 없음)
    - _요구사항: 1.1, 7.3_

  - [x] 2.2 신규 weekly_reports 테이블 생성 및 모델 정의
    - `weekly_reports` 테이블 생성 SQL 실행
    - SQLAlchemy 모델 정의: id, user_id, nickname, week_start, week_end, average_score, evaluation, daily_analysis, patterns, feedback, created_at
    - 인덱스 생성: user_id+created_at, nickname, week_start+week_end
    - _요구사항: 7.3_

  - [ ]* 2.3 일기 항목 검색을 위한 속성 테스트 작성
    - **속성 1: 완전한 일기 항목 검색**
    - **검증: 요구사항 1.1**

  - [x] 2.4 데이터베이스 리포지토리 레이어 구현
    - `HistoryRepository`: `get_entries_by_user_and_period()` - history 테이블에서 user_id와 record_date 기준 조회
    - `UserRepository`: `get_user_by_id()`, `get_user_by_nickname()` - users 테이블 조회
    - `ReportRepository`: `save_report()`, `get_latest_report_by_user()`, `get_report_by_nickname()` - weekly_reports 테이블 CRUD
    - _요구사항: 1.1, 7.3, 7.5_

  - [ ]* 2.5 사용자 데이터 격리를 위한 속성 테스트 작성
    - **속성 23: 사용자 데이터 격리**
    - **검증: 요구사항 9.1**

- [x] 3. Cognito 인증 및 사용자 관리 구현
  - [x] 3.1 Cognito 서비스 클라이언트 생성
    - boto3 클라이언트를 사용한 `CognitoService` 클래스 구현
    - JWT 토큰 검증을 위한 `verify_token()` 메서드 추가
    - sub, email, preferred_username을 가져오는 `get_user_info()` 메서드 추가
    - preferred_username으로 사용자를 찾는 `get_user_by_nickname()` 메서드 추가
    - _요구사항: 1.2, 1.5, 6.2, 7.2_

  - [ ]* 3.2 사용자 식별을 위한 속성 테스트 작성
    - **속성 2: Cognito를 통한 사용자 식별**
    - **검증: 요구사항 1.2, 1.5**

  - [ ]* 3.3 인증 요구사항을 위한 속성 테스트 작성
    - **속성 16: 인증 요구사항**
    - **검증: 요구사항 6.2**

  - [x] 3.4 FastAPI 인증 의존성 구현
    - 토큰을 추출하고 검증하는 `get_current_user()` 의존성 생성
    - HTTP 401 응답으로 인증 오류 처리
    - _요구사항: 6.2, 9.4_

  - [ ]* 3.5 인증 오류를 위한 속성 테스트 작성
    - **속성 18: 오류 응답 코드** (인증 부분)
    - **검증: 요구사항 9.4**

- [ ] 4. 체크포인트 - 데이터베이스 및 인증 테스트 통과 확인
  - 모든 테스트가 통과하는지 확인하고, 질문이 있으면 사용자에게 문의합니다.

- [x] 5. AWS Bedrock 통합 구현
  - [x] 5.1 Bedrock 서비스 클라이언트 생성
    - boto3 bedrock-runtime 클라이언트를 사용한 `BedrockService` 클래스 구현
    - Flow ID (BZKT7TJGPT) 및 Alias ID (QENFHYZ1KE) 구성
    - Bedrock Flow를 호출하는 `analyze_sentiment()` 메서드 추가
    - 타임아웃 처리 구현 (최대 30초)
    - 지수 백오프를 사용한 재시도 로직 구현
    - _요구사항: 2.1, 2.2, 12.1, 12.4_

  - [x] 5.2 Bedrock용 일기 항목 포맷팅 구현
    - DiaryEntry를 Bedrock 문서 형식으로 변환하는 `format_entries_for_bedrock()` 함수 생성
    - 각 문서에 일기 내용, 작성 날짜, 작성자 닉네임 포함 보장
    - _요구사항: 2.3_

  - [ ]* 5.3 Bedrock 문서 포맷팅을 위한 속성 테스트 작성
    - **속성 5: Bedrock 문서 포맷팅**
    - **검증: 요구사항 2.3**

  - [ ]* 5.4 완전한 Bedrock 제출을 위한 속성 테스트 작성
    - **속성 4: 완전한 Bedrock 제출**
    - **검증: 요구사항 2.1**

  - [x] 5.5 Bedrock 응답 파싱 구현
    - Bedrock 출력을 파싱하여 일일 점수, 감정, 테마 추출
    - 파싱된 결과를 담을 `SentimentAnalysis` 데이터 클래스 생성
    - _요구사항: 2.4, 2.5_

  - [ ]* 5.6 점수-항목 연관성을 위한 속성 테스트 작성
    - **속성 7: 점수-항목 연관성**
    - **검증: 요구사항 2.5**

  - [ ]* 5.7 Bedrock 타임아웃 처리를 위한 속성 테스트 작성
    - **속성 33: Bedrock 타임아웃 처리**
    - **검증: 요구사항 12.4**

- [x] 6. 리포트 생성 로직 구현
  - [x] 6.1 리포트 분석 서비스 생성
    - `ReportAnalysisService` 클래스 구현
    - 주간 평균을 계산하는 `calculate_average_score()` 메서드 추가
    - 점수 임계값(5.0)을 기반으로 `determine_evaluation_type()` 메서드 추가
    - _요구사항: 3.1, 3.2, 3.3_

  - [ ]* 6.2 평균 점수 계산을 위한 속성 테스트 작성
    - **속성 8: 평균 점수 계산**
    - **검증: 요구사항 3.1**

  - [ ]* 6.3 평가 유형 결정을 위한 속성 테스트 작성
    - **속성 9: 평가 유형 결정**
    - **검증: 요구사항 3.2, 3.3**

  - [x] 6.4 패턴 감지 구현
    - 활동/날씨와 점수 간의 상관관계를 추출하는 `identify_patterns()` 메서드 추가
    - 유사한 점수 범위에서 나타나는 유사한 요인 그룹화
    - 패턴 빈도 및 평균 점수 계산
    - _요구사항: 3.4_

  - [ ]* 6.5 패턴 상관관계 감지를 위한 속성 테스트 작성
    - **속성 10: 패턴 상관관계 감지**
    - **검증: 요구사항 3.4**

  - [x] 6.6 극단적인 날 식별 구현
    - 최고/최저 점수 날을 찾는 `identify_extreme_days()` 메서드 추가
    - 평가 유형에 따른 로직 (부정적 → 최저, 긍정적 → 최고)
    - _요구사항: 4.1, 5.1_

  - [ ]* 6.7 극단적인 날 식별을 위한 속성 테스트 작성
    - **속성 12: 극단적인 날 식별**
    - **검증: 요구사항 4.1, 5.1**

  - [x] 6.8 테마 추출 구현
    - 일기 항목에서 공통 테마를 찾는 `extract_themes()` 메서드 추가
    - 항목 메타데이터 및 내용에서 활동, 경험, 날씨 추출
    - _요구사항: 4.2, 5.2_

  - [ ]* 6.9 테마 추출을 위한 속성 테스트 작성
    - **속성 13: 항목에서 테마 추출**
    - **검증: 요구사항 4.2, 5.2**

  - [x] 6.10 피드백 생성 구현
    - 실행 가능한 권장사항을 생성하는 `generate_feedback()` 메서드 추가
    - 피드백이 특정 날짜 및 일기 항목을 참조하도록 보장
    - 영향력(빈도 × 점수 상관관계)에 따라 패턴 우선순위 지정
    - _요구사항: 4.4, 4.5, 5.4, 5.5_

  - [ ]* 6.11 피드백 맥락화를 위한 속성 테스트 작성
    - **속성 14: 피드백 맥락화**
    - **검증: 요구사항 4.4, 5.4**

  - [ ]* 6.12 패턴 우선순위 지정을 위한 속성 테스트 작성
    - **속성 15: 패턴 우선순위 지정**
    - **검증: 요구사항 4.5, 5.5**

  - [ ]* 6.13 평가 증거 포함을 위한 속성 테스트 작성
    - **속성 11: 평가 증거 포함**
    - **검증: 요구사항 3.5**

- [ ] 7. 체크포인트 - 리포트 생성 테스트 통과 확인
  - 모든 테스트가 통과하는지 확인하고, 질문이 있으면 사용자에게 문의합니다.

- [x] 8. AWS SES 이메일 서비스 구현
  - [x] 8.1 SES 서비스 클라이언트 생성
    - boto3 SES 클라이언트를 사용한 `EmailService` 클래스 구현
    - 이메일을 보내는 `send_report_notification()` 메서드 추가
    - 지수 백오프를 사용한 재시도 로직 구현
    - _요구사항: 11.1, 11.3_

  - [x] 8.2 이메일 템플릿 생성
    - 요약 및 리포트 링크가 포함된 HTML 이메일 템플릿 디자인
    - 포함 내용: 닉네임, 주간 기간, 평균 점수, 평가 유형, 링크
    - _요구사항: 11.4_

  - [ ]* 8.3 이메일 알림 트리거를 위한 속성 테스트 작성
    - **속성 29: 이메일 알림 트리거**
    - **검증: 요구사항 11.1**

  - [ ]* 8.4 이메일 주소 검색을 위한 속성 테스트 작성
    - **속성 30: 이메일 주소 검색**
    - **검증: 요구사항 11.2**

  - [ ]* 8.5 이메일 내용 완전성을 위한 속성 테스트 작성
    - **속성 31: 이메일 내용 완전성**
    - **검증: 요구사항 11.4**

  - [ ]* 8.6 이메일 실패 복원력을 위한 속성 테스트 작성
    - **속성 32: 이메일 실패 복원력**
    - **검증: 요구사항 11.5**

- [x] 9. API 엔드포인트 구현
  - [x] 9.1 POST /report/create 엔드포인트 생성
    - 선택적 startDate 및 endDate 매개변수 허용
    - 날짜 형식 및 범위 검증
    - 현재 사용자를 가져오기 위한 인증 의존성 호출
    - 사용자 및 기간에 대한 일기 항목 가져오기
    - 불충분한 데이터 오류 처리 (항목 없음)
    - 감정 분석을 위해 Bedrock 호출
    - ReportAnalysisService를 사용하여 리포트 생성
    - 데이터베이스에 리포트 저장
    - 이메일 알림 전송 (비차단)
    - 완전한 리포트와 함께 HTTP 200 반환
    - _요구사항: 6.1, 6.2, 6.3, 6.4, 1.3, 1.4_

  - [ ]* 9.2 성공 응답 형식을 위한 속성 테스트 작성
    - **속성 17: 성공 응답 형식**
    - **검증: 요구사항 6.4**

  - [ ]* 9.3 불충분한 데이터 오류를 위한 속성 테스트 작성
    - **속성 3: 불충분한 데이터 오류 처리**
    - **검증: 요구사항 1.4**

  - [x] 9.4 GET /report/create/{nickname} 엔드포인트 생성
    - 경로 매개변수에서 닉네임 추출
    - Cognito에서 닉네임으로 사용자 조회
    - 데이터베이스에서 사용자의 가장 최근 리포트 검색
    - 리포트가 없으면 HTTP 404 반환
    - 필수 필드가 포함된 리포트 요약 반환
    - _요구사항: 7.1, 7.2, 7.3, 7.4, 7.5_

  - [ ]* 9.5 닉네임 기반 사용자 조회를 위한 속성 테스트 작성
    - **속성 19: 닉네임 기반 사용자 조회**
    - **검증: 요구사항 7.2**

  - [ ]* 9.6 가장 최근 리포트 검색을 위한 속성 테스트 작성
    - **속성 20: 가장 최근 리포트 검색**
    - **검증: 요구사항 7.3**

  - [ ]* 9.7 리포트 요약 완전성을 위한 속성 테스트 작성
    - **속성 21: 리포트 요약 완전성**
    - **검증: 요구사항 7.4**

  - [ ]* 9.8 찾을 수 없음 처리를 위한 속성 테스트 작성
    - **속성 22: 찾을 수 없음 처리**
    - **검증: 요구사항 7.5**

  - [x] 9.9 포괄적인 오류 처리 구현
    - 모든 오류 유형(400, 401, 404, 500, 503)에 대한 예외 핸들러 추가
    - 설명이 포함된 메시지와 함께 적절한 HTTP 상태 코드 반환
    - 로그 데이터 정제 구현 (로그에 원시 일기 내용 없음)
    - _요구사항: 6.5, 9.3, 12.1, 12.2_

  - [ ]* 9.10 오류 응답 코드를 위한 속성 테스트 작성
    - **속성 18: 오류 응답 코드**
    - **검증: 요구사항 6.5, 12.1, 12.2**

  - [ ]* 9.11 로그 데이터 정제를 위한 속성 테스트 작성
    - **속성 24: 로그 데이터 정제**
    - **검증: 요구사항 9.3**

- [ ] 10. 체크포인트 - API 테스트 통과 확인
  - 모든 테스트가 통과하는지 확인하고, 질문이 있으면 사용자에게 문의합니다.

- [x] 11. Lambda 스케줄러 함수 구현
  - [x] 11.1 예약 실행을 위한 Lambda 핸들러 생성
    - `lambda_handler()` 함수 구현
    - 이전 주에 일기 항목이 있는 사용자를 데이터베이스에서 쿼리
    - 적격 사용자 식별을 위해 사용자 필터링 (최소 하나의 항목)
    - _요구사항: 10.2_

  - [ ]* 11.2 적격 사용자 식별을 위한 속성 테스트 작성
    - **속성 26: 적격 사용자 식별**
    - **검증: 요구사항 10.2**

  - [x] 11.3 배치 리포트 생성 구현
    - 각 적격 사용자에 대해 리포트 생성 API 호출
    - 동시 처리를 위해 asyncio 사용
    - 오류 격리 구현 (개별 실패 시 계속 진행)
    - 실행 요약 로깅 (총 사용자 수, 성공, 실패)
    - _요구사항: 10.3, 10.5_

  - [ ]* 11.4 배치 리포트 생성을 위한 속성 테스트 작성
    - **속성 27: 배치 리포트 생성**
    - **검증: 요구사항 10.3**

  - [ ]* 11.5 배치 처리에서 오류 격리를 위한 속성 테스트 작성
    - **속성 28: 배치 처리에서 오류 격리**
    - **검증: 요구사항 10.5**

  - [x] 11.6 Lambda 배포 패키지 생성
    - 핸들러가 포함된 `lambda_function.py` 생성
    - Lambda 의존성을 위한 `requirements.txt` 생성
    - Lambda 환경 변수 구성 (API 엔드포인트, 자격 증명)
    - _요구사항: 10.4_

- [x] 12. Kubernetes 배포 구성 생성
  - [x] 12.1 Deployment 매니페스트 생성
    - 고가용성을 위한 3개의 복제본이 있는 배포 정의
    - 컨테이너 이미지, 포트, 환경 변수 구성
    - 리소스 제한 설정 (CPU, 메모리)
    - 상태 확인 프로브 추가 (liveness, readiness)
    - _요구사항: 8.1, 8.2_

  - [x] 12.2 Service 매니페스트 생성
    - 내부적으로 파드를 노출하는 ClusterIP 서비스 정의
    - 포트 매핑 구성 (80 → 3000)
    - _요구사항: 8.2_

  - [x] 12.3 Ingress 매니페스트 생성
    - ALB ingress controller 어노테이션 구성
    - api.aws11.shop/report/*에 대한 라우팅 규칙 정의
    - SSL/TLS 종료 구성
    - _요구사항: 8.3, 8.4_

  - [x] 12.4 ConfigMap 및 Secrets 생성
    - 민감하지 않은 구성을 위한 ConfigMap 생성 (Bedrock ID, 타임아웃)
    - AWS Secrets Manager 시크릿에 대한 액세스 구성: `library-api/db-password`
    - Secrets Manager를 사용하여 데이터베이스 연결 정보 검색
    - 배포에서 Secrets Manager의 환경 변수 설정
    - _요구사항: 8.1_

- [x] 13. CI/CD 파이프라인 구성 생성
  - [x] 13.1 GitHub Actions 워크플로우 생성
    - 워크플로우 트리거 정의 (main 브랜치로 푸시)
    - 테스트 실행을 위한 작업 추가 (hypothesis를 사용한 pytest)
    - Docker 이미지 빌드를 위한 작업 추가
    - ECR로 이미지 푸시를 위한 작업 추가
    - EKS로 배포를 위한 작업 추가 (kubectl apply)
    - _요구사항: 8.5_

  - [x] 13.2 Dockerfile 생성
    - Python 3.11 베이스 이미지 사용
    - requirements.txt에서 의존성 설치
    - 애플리케이션 코드 복사
    - 보안을 위한 비루트 사용자 설정
    - FastAPI 서버를 위한 ENTRYPOINT 정의
    - _요구사항: 8.1_

- [-] 14. EventBridge 스케줄러 구성 생성
  - [x] 14.1 일요일 자정 트리거를 위한 EventBridge 규칙 생성
    - cron 표현식 정의: `cron(0 0 ? * SUN *)`
    - Lambda 함수를 대상으로 구성
    - EventBridge가 Lambda를 호출하기 위한 IAM 역할 설정
    - _요구사항: 10.1_

  - [x] 14.2 Lambda 권한 구성
    - Lambda가 API, Cognito, 데이터베이스에 액세스하기 위한 IAM 정책 추가
    - 데이터베이스가 프라이빗 서브넷에 있는 경우 VPC 설정 구성
    - _요구사항: 10.4_

- [ ] 15. 통합 테스트 작성
  - [ ]* 15.1 수동 리포트 생성 플로우 테스트
    - 시뮬레이션: 사용자 인증 → 리포트 요청 → 응답 수신
    - 검증: 모든 구성 요소가 엔드투엔드로 함께 작동
    - _요구사항: 6.1, 6.4_

  - [ ]* 15.2 자동 주간 플로우 테스트
    - 시뮬레이션: EventBridge가 Lambda 트리거 → 리포트 생성 → 이메일 전송
    - 검증: 배치 처리가 성공적으로 완료
    - _요구사항: 10.1, 10.3, 11.1_

  - [ ]* 15.3 오류 복구 플로우 테스트
    - 시뮬레이션: Bedrock 사용 불가 → 시스템 재시도 → 503 반환
    - 검증: 적절한 오류 처리 및 재시도 로직
    - _요구사항: 12.1_

  - [ ]* 15.4 부분 데이터 플로우 테스트
    - 시뮬레이션: 사용자가 3일치 일기만 보유 → 경고와 함께 리포트 생성
    - 검증: 불완전한 데이터에 대한 경고 포함
    - _요구사항: 12.5_

  - [ ]* 15.5 부분 데이터 경고를 위한 속성 테스트 작성
    - **속성 34: 부분 데이터 경고**
    - **검증: 요구사항 12.5**

- [ ] 16. 최종 체크포인트 - 전체 시스템 검증
  - 전체 테스트 스위트 실행 (단위 + 속성 + 통합 테스트)
  - 34개의 모든 정확성 속성이 통과하는지 확인
  - 코드 커버리지가 80% 임계값을 충족하는지 확인
  - 배포 전에 질문이 있으면 사용자에게 문의합니다.

## 참고사항

- `*`로 표시된 작업은 선택 사항이며 더 빠른 MVP를 위해 건너뛸 수 있습니다
- 각 작업은 추적 가능성을 위해 특정 요구사항을 참조합니다
- 체크포인트는 점진적인 검증을 보장합니다
- 속성 테스트는 보편적인 정확성 속성을 검증합니다 (각각 최소 100회 반복)
- 단위 테스트는 특정 예제 및 엣지 케이스를 검증합니다
- 통합 테스트는 엔드투엔드 플로우를 검증합니다
- 구현에는 FastAPI, pytest, hypothesis를 사용한 Python이 사용됩니다
- AWS 서비스: Bedrock, SES, Cognito, Lambda, EventBridge
- 배포: ALB ingress를 사용한 Kubernetes (EKS)

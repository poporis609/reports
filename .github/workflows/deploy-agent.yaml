name: Deploy AgentCore

on:
  push:
    branches: [main]
    paths:
      - 'agent/**'
  workflow_dispatch:

env:
  AWS_REGION: us-east-1
  ECR_REPOSITORY: bedrock-agentcore-my_agent
  AGENT_NAME: my_agent

jobs:
  deploy-agent:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ env.AWS_REGION }}

      - name: Login to Amazon ECR
        id: login-ecr
        uses: aws-actions/amazon-ecr-login@v2

      - name: Set up QEMU (for ARM64)
        uses: docker/setup-qemu-action@v3

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Build and push Docker image
        env:
          ECR_REGISTRY: ${{ steps.login-ecr.outputs.registry }}
          IMAGE_TAG: ${{ github.sha }}
        run: |
          cd agent
          
          # Dockerfile 생성
          cat > Dockerfile << 'EOF'
          FROM --platform=linux/arm64 public.ecr.aws/docker/library/python:3.11-slim
          
          WORKDIR /app
          
          RUN apt-get update && apt-get install -y --no-install-recommends \
              gcc \
              && rm -rf /var/lib/apt/lists/*
          
          COPY requirements.txt .
          RUN pip install --no-cache-dir -r requirements.txt
          RUN pip install --no-cache-dir aws-opentelemetry-distro
          
          COPY my_agent.py .
          COPY tools.py .
          
          ENV PYTHONUNBUFFERED=1
          ENV AWS_REGION=us-east-1
          ENV API_BASE_URL=https://api.aws11.shop
          
          RUN useradd -m -u 1000 agentcore
          USER agentcore
          
          EXPOSE 8080
          
          CMD ["opentelemetry-instrument", "python", "-m", "my_agent"]
          EOF
          
          # ARM64 이미지 빌드 & 푸시
          docker buildx build \
            --platform linux/arm64 \
            -t $ECR_REGISTRY/$ECR_REPOSITORY:$IMAGE_TAG \
            -t $ECR_REGISTRY/$ECR_REPOSITORY:latest \
            --push \
            .

      - name: Deploy to AgentCore Runtime
        env:
          ECR_REGISTRY: ${{ steps.login-ecr.outputs.registry }}
          IMAGE_TAG: ${{ github.sha }}
        run: |
          pip install boto3
          
          # AWS CLI로 AgentCore Runtime 생성/업데이트
          IMAGE_URI="${ECR_REGISTRY}/${ECR_REPOSITORY}:${IMAGE_TAG}"
          ROLE_ARN="arn:aws:iam::324547056370:role/AmazonBedrockAgentCoreSDKRuntime-us-east-1-e72c1a7c7a"
          
          echo "Image URI: $IMAGE_URI"
          
          # 기존 Runtime 확인
          EXISTING=$(aws bedrock-agentcore-control list-agent-runtimes --region $AWS_REGION --query "agentRuntimes[?agentRuntimeName=='$AGENT_NAME'].agentRuntimeId" --output text 2>/dev/null || echo "")
          
          if [ -n "$EXISTING" ] && [ "$EXISTING" != "None" ]; then
            echo "Updating existing runtime: $EXISTING"
            aws bedrock-agentcore-control update-agent-runtime \
              --agent-runtime-id "$EXISTING" \
              --agent-runtime-artifact "containerConfiguration={containerUri=$IMAGE_URI}" \
              --region $AWS_REGION
          else
            echo "Creating new runtime: $AGENT_NAME"
            aws bedrock-agentcore-control create-agent-runtime \
              --agent-runtime-name "$AGENT_NAME" \
              --description "Weekly Report AI Agent" \
              --agent-runtime-artifact "containerConfiguration={containerUri=$IMAGE_URI}" \
              --role-arn "$ROLE_ARN" \
              --network-configuration "networkMode=PUBLIC" \
              --region $AWS_REGION
          fi

      - name: Output Agent Info
        run: |
          echo "✅ Agent deployed successfully!"
          echo "Image: ${{ steps.login-ecr.outputs.registry }}/${{ env.ECR_REPOSITORY }}:${{ github.sha }}"
